<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/layout :: layout(~{::body/content()})}">
  <head>
    <title>HOME</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>

  <body>
    <main>
      <div class="container">
        <div class="row center">
          <h3 th:text="${sample}"></h3>
        </div>

        <div class="section">
          <div class="row center">
            <div th:switch="${session.user}"></div>
          </div>
        </div>

        <div class="row">
          <div class="col s12 m6 l4" th:if="${session.user != null && session.user.authority == 1}">
            <div class="card-panel blue-grey lighten-4 ">
              <a class="btn-floating right waves-effect waves-light red btn-large modal-trigger modal-close" href="#modal1">
                <i class="material-icons">add</i>
              </a>
              <div class="card-content dark-text">
                <span class="card-title">情報新規登録</span>
                <p>ボタンをクリック</p>
              </div>
            </div>
          </div>

          <!-- Modal Structure -->
          <div id="modal1" class="modal">
            <form id="modalForm" method="post">
              <div class="modal-content">
                <h3 class="center row">情報新規登録</h3>
                <div class="row">
                  <div class="input-field col offset-s2 s8">
                    <input id="bbsTitle" name="bbsTitle" type="text" class="validate" data-length="20" />
                    <label for="bbsTitle">タイトル</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col offset-s2 s8">
                    <input id="bbsAuthor" name="bbsAuthor" type="text" class="validate" data-length="20" />
                    <label for="bbsAuthor">署名</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col offset-s2 s8">
                    <textarea id="bbsContent" class="materialize-textarea validate" data-length="200"></textarea>
                    <label for="bbsContent">内容</label>
                  </div>
                </div>
              </div>
              <div class="row center">
                <a href="#!" class="modal-close waves-effect waves-red btn back">戻る</a>
                <button id="submitButton" class="modal-close waves-effect waves-green btn" type="submit">登録</button>
              </div>
            </form>
          </div>

          <div id="bbsLoading" class="col s12 m6 l4 card-like-loading valign-wrapper" style="padding-left: 100px">
            <div class="preloader-wrapper big active">
              <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                  <div class="circle"></div>
                </div>
                <div class="gap-patch">
                  <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                  <div class="circle"></div>
                </div>
              </div>
            </div>
          </div>

          <span id="bbsField"> </span>

          <script>
            window.onload = initBBS();
            function initBBS() {
              $("#bbsLoading").show();
              $.ajax({
                type: "get",
                url: "/bbs/listAllBBS",
                data: {},
                success: function (data) {
                  var str = "\n";
                  var bbs = $("#bbsField").empty();
                  if (data.length > 0) {
                    $("#bbsLoading").hide();
                    for (var i = 0; i < data.length; i++) {
                      str +=
                        '<div class="col s12 m6 l4">\n' +
                        '<div class="card blue-grey darken-1">\n' +
                          
                       ' <a th:if="${session.user != null && session.user.authority == 1}" class="right" onclick="bbsDelete('+data[i].bulletinBoardId+')">\n' +
                          '<i class="material-icons">clear</i>\n' +
                        '</a>\n' +

                        '<div class="card-content white-text">\n' +
                        '<span class="card-title">' +
                        data[i].bbsTitle +
                        "</span>\n" +
                        "<p>" +
                        timestamp2String(data[i].createTime) +
                        "\t" +
                        data[i].bbsAuthor +
                        "</p>\n" +
                        "<p>" +
                        data[i].bbsContent +
                        "</p>\n" +
                        "</div>\n" +
                        "</div>\n" +
                        "</div>\n";
                    }
                  }
                  $("#bbsField").html(str);
                },
              });
            };

            $(submitButton).click(function () {
              var bbsTitle = $("#bbsTitle").val();
              var bbsAuthor = $("#bbsAuthor").val();
              var bbsContent = $("#bbsContent").val();
              var createTime = new Date().getTime();
              $.ajax({
                type: "post",
                url: "/bbs/create",
                async: false,
                dataType: "json",
                data: {
                  bbsTitle: bbsTitle,
                  bbsAuthor: bbsAuthor,
                  bbsContent: bbsContent,
                  createTime: createTime,
                },
                success: function (data) {
                },
              });
            });

            function bbsDelete(index) {
              if(confirmDelete()){
                $.ajax(
                  {
                  type: "get",
                  url: "/bbs/delete",
                  async: false,
                  dataType: "text",
                  data: {index: index},
                  success: function (data) {
                    if (data>0) {
                    }
                  },
                  }
                )
              initBBS();
              }
            }

            function confirmDelete() {
              if (confirm('削除をご確認ください')) {
                return true;
              }else{
                return false;
              }
            }

            function timestamp2String(ts) {
              var date = new Date(ts); // 参数需要毫秒数，所以这里将秒数乘于 1000
              return date.toLocaleDateString();
            }

            function checkUnauthority(authority) {
              if (user.authority == 1) {
                return false;
              }else{
                alert('管理者アカウントにログインしてください');
                return true;
              }
            }
          </script>
        </div>
      </div>
    </main>
  </body>
</html>
